name: Build, Test and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal --filter "FullyQualifiedName!~IntegrationTests"

  deploy:
    needs: build
    runs-on: [self-hosted, handbook-search]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET environment
      run: |
        echo "PATH=/home/jirka/.dotnet:$PATH" >> $GITHUB_ENV
        echo "DOTNET_ROOT=/home/jirka/.dotnet" >> $GITHUB_ENV

    - name: Check SecureStore configuration
      run: |
        SECRETS_FILE=~/.config/handbook-search/secrets/secrets.json
        KEY_FILE=~/.config/handbook-search/keys/secrets.key
        MISSING_FILES=false

        if [ ! -f "$SECRETS_FILE" ]; then
          echo "::warning::SecureStore vault not found at $SECRETS_FILE"
          MISSING_FILES=true
        else
          echo "SecureStore vault found at $SECRETS_FILE"
        fi

        if [ ! -f "$KEY_FILE" ]; then
          echo "::warning::SecureStore key not found at $KEY_FILE"
          MISSING_FILES=true
        else
          echo "SecureStore key found at $KEY_FILE"
        fi

        if [ "$MISSING_FILES" = true ]; then
          echo "Application will start but may fail if secrets decryption is required."
        fi

    - name: Deploy to production
      working-directory: ${{ github.workspace }}
      run: |
        chmod +x ./deploy/deploy.sh
        ./deploy/deploy.sh
